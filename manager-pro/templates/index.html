{% extends "base.html" %}
{% block content %}

<!-- DASHBOARD -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
  <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-2xl p-8 shadow-2xl">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-blue-100">Dossiers</p>
        <p class="text-5xl font-bold">{{ stats.folders }}</p>
      </div>
      <i class="fas fa-folder-open text-8xl opacity-30"></i>
    </div>
  </div>

  <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-2xl p-8 shadow-2xl">
    <div class="flex justify-between items-center">
      <div>
        <p class="text-green-100">Fichiers</p>
        <p class="text-5xl font-bold">{{ stats.files }}</p>
      </div>
      <i class="fas fa-file-alt text-8xl opacity-30"></i>
    </div>
  </div>

  <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-2xl p-8 shadow-2xl relative overflow-hidden">
    <p class="text-purple-100">Stockage utilisé</p>
    <p class="text-4xl font-bold mt-2">{{ stats.storage }}</p>
    <div class="mt-5 bg-white/30 rounded-full h-5">
      <div class="bg-white h-full rounded-full transition-all duration-1000" style="width: {{ stats.percentage }}%"></div>
    </div>
    <p class="text-sm mt-2 opacity-90">{{ stats.percentage }} % de 100 Go</p>
    <i class="fas fa-hdd text-8xl opacity-20 absolute bottom-4 right-4"></i>
  </div>
</div>

<!-- Breadcrumb -->
{% if breadcrumb or current_folder %}
<div class="bg-white rounded-lg shadow p-4 mb-6 flex items-center gap-3 text-sm">
  <a href="/" class="text-blue-600 hover:underline">Racine</a>
  {% for crumb in breadcrumb %}
    <span>/</span>
    <a href="/folder/{{ crumb.id }}" class="text-blue-600 hover:underline">{{ crumb.name }}</a>
  {% endfor %}
  {% if current_folder %}
    <span>/</span>
    <strong>{{ current_folder.name }}</strong>
  {% endif %}
</div>
{% endif %}

<div class="flex justify-between items-center mb-6">
  <h2 class="text-3xl font-bold">
    {% if current_folder %}{{ current_folder.name }}{% else %}Mes Documents{% endif %}
  </h2>
  <button onclick="showCreateFolderModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 flex items-center gap-2 shadow-lg">
    <i class="fas fa-folder-plus"></i> Nouveau dossier
  </button>
</div>

<!-- Zone Upload -->
<div id="dropZone" class="bg-white rounded-xl shadow-lg p-12 mb-8 text-center border-2 border-dashed border-gray-300 hover:border-blue-500 transition cursor-pointer">
  <input type="file" name="files" multiple id="fileInput" class="hidden">
  <input type="hidden" id="currentFolderInput" value="{{ current_folder_id }}">
  <i class="fas fa-cloud-upload-alt text-7xl text-gray-400 mb-4"></i>
  <p class="text-2xl font-bold">Glissez vos fichiers ici</p>
  <p class="text-gray-600">ou cliquez pour sélectionner</p>
</div>

<!-- Grille fichiers/dossiers -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
  {% for folder in folders %}
  <div class="group relative">
    <a href="/folder/{{ folder.id }}" class="block">
      <div class="bg-yellow-100 h-40 rounded-xl flex items-center justify-center hover:bg-yellow-200 transition">
        <i class="fas fa-folder text-8xl text-yellow-600"></i>
      </div>
      <p class="mt-3 text-center truncate px-2 font-medium">{{ folder.name }}</p>
    </a>
    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 flex gap-1">
      <button onclick="renameFolder({{ folder.id }}, '{{ folder.name|escape }}', event)" class="bg-white p-2 rounded shadow"><i class="fas fa-edit"></i></button>
      <button onclick="deleteFolder({{ folder.id }}, event)" class="bg-white p-2 rounded shadow"><i class="fas fa-trash text-red-600"></i></button>
    </div>
  </div>
  {% endfor %}

  {% for file in files %}
  <div class="group relative cursor-move">
    <div class="h-40 bg-gray-50 rounded-xl overflow-hidden">
      {% if file.filename.endswith('.pdf') %}
        <div onclick="openPreview({{ file.id }})" class="w-full h-full flex items-center justify-center cursor-pointer">
          <i class="fas fa-file-pdf text-8xl text-red-600 opacity-70"></i>
        </div>
      {% else %}
        <img src="{{ file.url }}" class="w-full h-full object-cover" loading="lazy">
      {% endif %}
    </div>
    <p class="mt-3 text-center truncate px-2 font-medium">{{ file.name }}</p>
    <div class="absolute inset-0 bg-black/70 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-4">
      <a href="{{ file.url }}" class="bg-blue-600 p-4 rounded-full hover:bg-blue-700"><i class="fas fa-download"></i></a>
      {% if file.filename.endswith('.pdf') %}<button onclick="openPreview({{ file.id }})" class="bg-purple-600 p-4 rounded-full"><i class="fas fa-eye"></i></button>{% endif %}
      <button onclick="navigator.clipboard.writeText('{{ file.share_url }}'); alert('Lien copié !')" class="bg-green-600 p-4 rounded-full"><i class="fas fa-share"></i></button>
      <button onclick="deleteFile({{ file.id }}, this)" class="bg-red-600 p-4 rounded-full"><i class="fas fa-trash"></i></button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modals -->
<div id="createFolderModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl p-8 max-w-md w-full">
    <h3 class="text-2xl font-bold mb-4">Nouveau dossier</h3>
    <input type="text" id="newFolderName" class="w-full px-4 py-3 border rounded-lg mb-4" placeholder="Nom du dossier">
    <div class="flex gap-4">
      <button onclick="createFolder()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg">Créer</button>
      <button onclick="document.getElementById('createFolderModal').classList.add('hidden')" class="flex-1 bg-gray-300 py-3 rounded-lg">Annuler</button>
    </div>
  </div>
</div>

<div id="pdfModal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl w-full max-w-6xl h-5/6 relative">
    <button onclick="document.getElementById('pdfModal').classList.add('hidden')" class="absolute top-4 right-4 bg-red-600 text-white p-4 rounded-full z-10">
      <i class="fas fa-times text-2xl"></i>
    </button>
    <iframe id="pdfViewer" class="w-full h-full rounded-xl"></iframe>
  </div>
</div>

<script>
const currentFolderId = "{{ current_folder_id }}";

function showCreateFolderModal() {
  document.getElementById('createFolderModal').classList.remove('hidden');
  document.getElementById('newFolderName').focus();
}

function createFolder() {
  const name = document.getElementById('newFolderName').value.trim();
  if (!name) return alert('Nom requis');

  fetch('/folder/create', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({name, parent_id: currentFolderId === 'null' ? null : currentFolderId})
  }).then(() => location.reload());
}

// Upload & Drag & Drop
const dropZone = document.getElementById('dropZone');
dropZone.onclick = () => document.getElementById('fileInput').click();

['dragover', 'dragenter'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); }));
['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); }));

dropZone.ondrop = e => {
  const files = e.dataTransfer.files;
  if (files.length) uploadFiles(files);
};

document.getElementById('fileInput').onchange = e => {
  if (e.target.files.length) uploadFiles(e.target.files);
};

function uploadFiles(files) {
  const fd = new FormData();
  for (let f of files) fd.append('files', f);
  fd.append('current_folder_id', currentFolderId);
  fetch('/upload', {method: 'POST', body: fd}).then(() => location.reload());
}

function openPreview(id) {
  document.getElementById('pdfViewer').src = '/preview/' + id;
  document.getElementById('pdfModal').classList.remove('hidden');
}

function deleteFile(id) {
  if (confirm('Supprimer ?')) {
    fetch('/delete/' + id, {method: 'DELETE'}).then(() => location.reload());
  }
}

function renameFolder(id, oldName, e) {
  e.stopPropagation();
  const name = prompt('Nouveau nom :', oldName);
  if (name && name !== oldName) {
    fetch('/folder/rename/' + id, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name})
    }).then(() => location.reload());
  }
}

function deleteFolder(id, e) {
  e.stopPropagation();
  if (confirm('Supprimer le dossier ? (contenu vers racine)')) {
    fetch('/folder/delete/' + id, {method: 'DELETE'}).then(() => location.reload());
  }
}
</script>

{% endblock %}